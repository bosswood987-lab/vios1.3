
import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { Plus, Trash2, Printer, Edit, RefreshCw, Eye, Glasses, ArrowRight, Copy, Mail } from "lucide-react";
import { format } from "date-fns";
import { toast } from "sonner"; // Assuming sonner is used for toasts
import { genererPdfEtOuvrirEmail } from "./PdfEmailHelper";

// Tables de conversion complètes selon le PDF CooperVision avec codes couleurs
// Structure: { "sphère_cylindre": { sph: "...", cyl: "..." } }

const CONVERSION_TABLE_HYPERMETROPES = {
  "+0.25_-0.50": { sph: "+0.25", cyl: "" },
  "+0.25_-0.75": { sph: "Plan", cyl: "-0.75" },
  "+0.25_-1.00": { sph: "+0.25", cyl: "-0.75" },
  "+0.25_-1.25": { sph: "Plan", cyl: "-1.25" },
  "+0.25_-1.50": { sph: "+0.25", cyl: "-1.25" },
  "+0.25_-1.75": { sph: "Plan", cyl: "-1.75" },
  "+0.25_-2.00": { sph: "+0.25", cyl: "-1.75" },
  "+0.25_-2.25": { sph: "Plan", cyl: "-2.25" },
  "+0.25_-2.50": { sph: "Plan", cyl: "-2.25" },
  
  "+0.50_-0.50": { sph: "+0.25", cyl: "" },
  "+0.50_-0.75": { sph: "+0.50", cyl: "-0.75" },
  "+0.50_-1.00": { sph: "+0.25", cyl: "-1.25" },
  "+0.50_-1.25": { sph: "+0.50", cyl: "-1.25" },
  "+0.50_-1.50": { sph: "+0.25", cyl: "-1.75" },
  "+0.50_-1.75": { sph: "+0.50", cyl: "-1.75" },
  "+0.50_-2.00": { sph: "+0.25", cyl: "-2.25" },
  "+0.50_-2.25": { sph: "+0.50", cyl: "-2.25" },
  "+0.50_-2.50": { sph: "+0.25", cyl: "-2.75" },
  
  "+0.75_-0.50": { sph: "+0.50", cyl: "" },
  "+0.75_-0.75": { sph: "+0.75", cyl: "-0.75" },
  "+0.75_-1.00": { sph: "+0.50", cyl: "-1.25" },
  "+0.75_-1.25": { sph: "+0.75", cyl: "-1.25" },
  "+0.75_-1.50": { sph: "+0.50", cyl: "-1.75" },
  "+0.75_-1.75": { sph: "+0.75", cyl: "-1.75" },
  "+0.75_-2.00": { sph: "+0.50", cyl: "-2.25" },
  "+0.75_-2.25": { sph: "+0.75", cyl: "-2.25" },
  "+0.75_-2.50": { sph: "+0.50", cyl: "-2.75" },
  
  "+1.00_-0.50": { sph: "+0.75", cyl: "" },
  "+1.00_-0.75": { sph: "+1.00", cyl: "-0.75" },
  "+1.00_-1.00": { sph: "+0.75", cyl: "-1.25" },
  "+1.00_-1.25": { sph: "+1.00", cyl: "-1.25" },
  "+1.00_-1.50": { sph: "+0.75", cyl: "-1.75" },
  "+1.00_-1.75": { sph: "+1.00", cyl: "-1.75" },
  "+1.00_-2.00": { sph: "+0.75", cyl: "-2.25" },
  "+1.00_-2.25": { sph: "+1.00", cyl: "-2.25" },
  "+1.00_-2.50": { sph: "+0.75", cyl: "-2.75" },
  
  "+1.25_-0.50": { sph: "+1.00", cyl: "" },
  "+1.25_-0.75": { sph: "+1.25", cyl: "-0.75" },
  "+1.25_-1.00": { sph: "+1.00", cyl: "-1.25" },
  "+1.25_-1.25": { sph: "+1.25", cyl: "-1.25" },
  "+1.25_-1.50": { sph: "+1.00", cyl: "-1.75" },
  "+1.25_-1.75": { sph: "+1.25", cyl: "-1.75" },
  "+1.25_-2.00": { sph: "+1.00", cyl: "-2.25" },
  "+1.25_-2.25": { sph: "+1.25", cyl: "-2.25" },
  "+1.25_-2.50": { sph: "+1.00", cyl: "-2.75" },
  
  "+1.50_-0.50": { sph: "+1.25", cyl: "" },
  "+1.50_-0.75": { sph: "+1.50", cyl: "-0.75" },
  "+1.50_-1.00": { sph: "+1.25", cyl: "-1.25" },
  "+1.50_-1.25": { sph: "+1.50", cyl: "-1.25" },
  "+1.50_-1.50": { sph: "+1.25", cyl: "-1.75" },
  "+1.50_-1.75": { sph: "+1.50", cyl: "-1.75" },
  "+1.50_-2.00": { sph: "+1.25", cyl: "-2.25" },
  "+1.50_-2.25": { sph: "+1.50", cyl: "-2.25" },
  "+1.50_-2.50": { sph: "+1.25", cyl: "-2.75" },
  
  "+1.75_-0.50": { sph: "+1.50", cyl: "" },
  "+1.75_-0.75": { sph: "+1.75", cyl: "-0.75" },
  "+1.75_-1.00": { sph: "+1.50", cyl: "-1.25" },
  "+1.75_-1.25": { sph: "+1.75", cyl: "-1.25" },
  "+1.75_-1.50": { sph: "+1.50", cyl: "-1.75" },
  "+1.75_-1.75": { sph: "+1.75", cyl: "-1.75" },
  "+1.75_-2.00": { sph: "+1.50", cyl: "-2.25" },
  "+1.75_-2.25": { sph: "+1.75", cyl: "-2.25" },
  "+1.75_-2.50": { sph: "+1.50", cyl: "-2.75" },
  
  "+2.00_-0.50": { sph: "+1.75", cyl: "" },
  "+2.00_-0.75": { sph: "+2.00", cyl: "-0.75" },
  "+2.00_-1.00": { sph: "+1.75", cyl: "-1.25" },
  "+2.00_-1.25": { sph: "+2.00", cyl: "-1.25" },
  "+2.00_-1.50": { sph: "+1.75", cyl: "-1.75" },
  "+2.00_-1.75": { sph: "+2.00", cyl: "-1.75" },
  "+2.00_-2.00": { sph: "+1.75", cyl: "-2.25" },
  "+2.00_-2.25": { sph: "+2.00", cyl: "-2.25" },
  "+2.00_-2.50": { sph: "+1.75", cyl: "-2.75" },
  
  "+2.25_-0.50": { sph: "+2.00", cyl: "" },
  "+2.25_-0.75": { sph: "+2.25", cyl: "-0.75" },
  "+2.25_-1.00": { sph: "+2.00", cyl: "-1.25" },
  "+2.25_-1.25": { sph: "+2.25", cyl: "-1.25" },
  "+2.25_-1.50": { sph: "+2.00", cyl: "-1.75" },
  "+2.25_-1.75": { sph: "+2.25", cyl: "-1.75" },
  "+2.25_-2.00": { sph: "+2.00", cyl: "-2.25" },
  "+2.25_-2.25": { sph: "+2.25", cyl: "-2.25" },
  "+2.25_-2.50": { sph: "+2.00", cyl: "-2.75" },
  
  "+2.50_-0.50": { sph: "+2.25", cyl: "" },
  "+2.50_-0.75": { sph: "+2.50", cyl: "-0.75" },
  "+2.50_-1.00": { sph: "+2.25", cyl: "-1.25" },
  "+2.50_-1.25": { sph: "+2.50", cyl: "-1.25" },
  "+2.50_-1.50": { sph: "+2.25", cyl: "-1.75" },
  "+2.50_-1.75": { sph: "+2.50", cyl: "-1.75" },
  "+2.50_-2.00": { sph: "+2.25", cyl: "-2.25" },
  "+2.50_-2.25": { sph: "+2.50", cyl: "-2.25" },
  "+2.50_-2.50": { sph: "+2.25", cyl: "-2.75" },
  
  "+2.75_-0.50": { sph: "+2.50", cyl: "" },
  "+2.75_-0.75": { sph: "+2.75", cyl: "-0.75" },
  "+2.75_-1.00": { sph: "+2.50", cyl: "-1.25" },
  "+2.75_-1.25": { sph: "+2.75", cyl: "-1.25" },
  "+2.75_-1.50": { sph: "+2.50", cyl: "-1.75" },
  "+2.75_-1.75": { sph: "+2.75", cyl: "-1.75" },
  "+2.75_-2.00": { sph: "+2.50", cyl: "-2.25" },
  "+2.75_-2.25": { sph: "+2.75", cyl: "-2.25" },
  "+2.75_-2.50": { sph: "+2.50", cyl: "-2.75" },
  
  "+3.00_-0.50": { sph: "+2.75", cyl: "" },
  "+3.00_-0.75": { sph: "+3.00", cyl: "-0.75" },
  "+3.00_-1.00": { sph: "+2.75", cyl: "-1.25" },
  "+3.00_-1.25": { sph: "+3.00", cyl: "-1.25" },
  "+3.00_-1.50": { sph: "+2.75", cyl: "-1.75" },
  "+3.00_-1.75": { sph: "+3.00", cyl: "-1.75" },
  "+3.00_-2.00": { sph: "+2.75", cyl: "-2.25" },
  "+3.00_-2.25": { sph: "+3.00", cyl: "-2.25" },
  "+3.00_-2.50": { sph: "+2.75", cyl: "-2.75" },
  
  "+3.25_-0.50": { sph: "+3.00", cyl: "" },
  "+3.25_-0.75": { sph: "+3.25", cyl: "-0.75" },
  "+3.25_-1.00": { sph: "+3.00", cyl: "-1.25" },
  "+3.25_-1.25": { sph: "+3.25", cyl: "-1.25" },
  "+3.25_-1.50": { sph: "+3.00", cyl: "-1.75" },
  "+3.25_-1.75": { sph: "+3.25", cyl: "-1.75" },
  "+3.25_-2.00": { sph: "+3.00", cyl: "-2.25" },
  "+3.25_-2.25": { sph: "+3.25", cyl: "-2.25" },
  "+3.25_-2.50": { sph: "+3.00", cyl: "-2.75" },
  
  "+3.50_-0.50": { sph: "+3.25", cyl: "" },
  "+3.50_-0.75": { sph: "+3.50", cyl: "-0.75" },
  "+3.50_-1.00": { sph: "+3.25", cyl: "-1.25" },
  "+3.50_-1.25": { sph: "+3.50", cyl: "-1.25" },
  "+3.50_-1.50": { sph: "+3.25", cyl: "-1.75" },
  "+3.50_-1.75": { sph: "+3.50", cyl: "-1.75" },
  "+3.50_-2.00": { sph: "+3.25", cyl: "-2.25" },
  "+3.50_-2.25": { sph: "+3.50", cyl: "-2.25" },
  "+3.50_-2.50": { sph: "+3.25", cyl: "-2.75" },
  
  "+3.75_-0.50": { sph: "+3.50", cyl: "" },
  "+3.75_-0.75": { sph: "+3.75", cyl: "-0.75" },
  "+3.75_-1.00": { sph: "+3.50", cyl: "-1.25" },
  "+3.75_-1.25": { sph: "+3.75", cyl: "-1.25" },
  "+3.75_-1.50": { sph: "+3.50", cyl: "-1.75" },
  "+3.75_-1.75": { sph: "+3.75", cyl: "-1.75" },
  "+3.75_-2.00": { sph: "+3.50", cyl: "-2.25" },
  "+3.75_-2.25": { sph: "+3.75", cyl: "-2.25" },
  "+3.75_-2.50": { sph: "+3.50", cyl: "-2.75" },
  
  "+4.00_-0.50": { sph: "+4.25", cyl: "" },
  "+4.00_-0.75": { sph: "+4.00", cyl: "-0.75" },
  "+4.00_-1.00": { sph: "+4.25", cyl: "-0.75" },
  "+4.00_-1.25": { sph: "+4.00", cyl: "-1.25" },
  "+4.00_-1.50": { sph: "+4.25", cyl: "-1.25" },
  "+4.00_-1.75": { sph: "+4.00", cyl: "-1.75" },
  "+4.00_-2.00": { sph: "+4.25", cyl: "-1.75" },
  "+4.00_-2.25": { sph: "+4.00", cyl: "-2.25" },
  "+4.00_-2.50": { sph: "+4.25", cyl: "-2.75" },
  
  "+4.25_-0.50": { sph: "+4.50", cyl: "" },
  "+4.25_-0.75": { sph: "+4.25", cyl: "-0.75" },
  "+4.25_-1.00": { sph: "+4.50", cyl: "-0.75" },
  "+4.25_-1.25": { sph: "+4.25", cyl: "-1.25" },
  "+4.25_-1.50": { sph: "+4.50", cyl: "-1.25" },
  "+4.25_-1.75": { sph: "+4.25", cyl: "-1.75" },
  "+4.25_-2.00": { sph: "+4.50", cyl: "-1.75" },
  "+4.25_-2.25": { sph: "+4.25", cyl: "-2.25" },
  "+4.25_-2.50": { sph: "+4.50", cyl: "-2.75" },
  
  "+4.50_-0.50": { sph: "+4.50", cyl: "" },
  "+4.50_-0.75": { sph: "+4.50", cyl: "-0.75" },
  "+4.50_-1.00": { sph: "+4.75", cyl: "-0.75" },
  "+4.50_-1.25": { sph: "+4.50", cyl: "-1.25" },
  "+4.50_-1.50": { sph: "+4.75", cyl: "-1.25" },
  "+4.50_-1.75": { sph: "+4.50", cyl: "-1.75" },
  "+4.50_-2.00": { sph: "+4.75", cyl: "-1.75" },
  "+4.50_-2.25": { sph: "+4.50", cyl: "-2.25" },
  "+4.50_-2.50": { sph: "+4.75", cyl: "-2.75" },
  
  "+4.75_-0.50": { sph: "+4.75", cyl: "" },
  "+4.75_-0.75": { sph: "+5.00", cyl: "-0.75" },
  "+4.75_-1.00": { sph: "+5.00", cyl: "-0.75" },
  "+4.75_-1.25": { sph: "+4.75", cyl: "-1.25" },
  "+4.75_-1.50": { sph: "+5.00", cyl: "-1.25" },
  "+4.75_-1.75": { sph: "+4.75", cyl: "-1.75" },
  "+4.75_-2.00": { sph: "+5.00", cyl: "-1.75" },
  "+4.75_-2.25": { sph: "+4.75", cyl: "-2.25" },
  "+4.75_-2.50": { sph: "+5.00", cyl: "-2.75" },
  
  "+5.00_-0.50": { sph: "+5.00", cyl: "" },
  "+5.00_-0.75": { sph: "+5.25", cyl: "-0.75" },
  "+5.00_-1.00": { sph: "+5.00", cyl: "-1.25" },
  "+5.00_-1.25": { sph: "+5.00", cyl: "-1.25" },
  "+5.00_-1.50": { sph: "+5.25", cyl: "-1.25" },
  "+5.00_-1.75": { sph: "+5.00", cyl: "-1.75" },
  "+5.00_-2.00": { sph: "+5.25", cyl: "-1.75" },
  "+5.00_-2.25": { sph: "+5.00", cyl: "-2.25" },
  "+5.00_-2.50": { sph: "+5.25", cyl: "-2.75" },
  
  "+5.25_-0.50": { sph: "+5.25", cyl: "" },
  "+5.25_-0.75": { sph: "+5.50", cyl: "-0.75" },
  "+5.25_-1.00": { sph: "+5.25", cyl: "-1.25" },
  "+5.25_-1.25": { sph: "+5.50", cyl: "-1.25" },
  "+5.25_-1.50": { sph: "+5.50", cyl: "-1.25" },
  "+5.25_-1.75": { sph: "+5.25", cyl: "-1.75" },
  "+5.25_-2.00": { sph: "+5.50", cyl: "-1.75" },
  "+5.25_-2.25": { sph: "+5.25", cyl: "-2.25" },
  "+5.25_-2.50": { sph: "+5.50", cyl: "-2.75" },
  
  "+5.50_-0.50": { sph: "+6.00", cyl: "" },
  "+5.50_-0.75": { sph: "+5.75", cyl: "-0.75" },
  "+5.50_-1.00": { sph: "+6.00", cyl: "-0.75" },
  "+5.50_-1.25": { sph: "+5.75", cyl: "-1.25" },
  "+5.50_-1.50": { sph: "+6.00", cyl: "-1.25" },
  "+5.50_-1.75": { sph: "+6.00", cyl: "-1.75" },
  "+5.50_-2.00": { sph: "+5.75", cyl: "-2.25" },
  "+5.50_-2.25": { sph: "+6.00", cyl: "-2.25" },
  "+5.50_-2.50": { sph: "+5.75", cyl: "-2.75" },
  
  "+5.75_-0.50": { sph: "+6.50", cyl: "" },
  "+5.75_-0.75": { sph: "+6.00", cyl: "-0.75" },
  "+5.75_-1.00": { sph: "+6.50", cyl: "-0.75" },
  "+5.75_-1.25": { sph: "+6.00", cyl: "-1.25" },
  "+5.75_-1.50": { sph: "+6.50", cyl: "-1.25" },
  "+5.75_-1.75": { sph: "+6.00", cyl: "-1.75" },
  "+5.75_-2.00": { sph: "+6.00", cyl: "-2.25" },
  "+5.75_-2.25": { sph: "+6.50", cyl: "-2.25" },
  "+5.75_-2.50": { sph: "+6.00", cyl: "-2.75" },
  
  "+6.00_-0.50": { sph: "+6.50", cyl: "" },
  "+6.00_-0.75": { sph: "+6.50", cyl: "-0.75" },
  "+6.00_-1.00": { sph: "+6.50", cyl: "-0.75" },
  "+6.00_-1.25": { sph: "+6.50", cyl: "-1.25" },
  "+6.00_-1.50": { sph: "+6.50", cyl: "-1.25" },
  "+6.00_-1.75": { sph: "+6.50", cyl: "-1.75" },
  "+6.00_-2.00": { sph: "+6.50", cyl: "-1.75" },
  "+6.00_-2.25": { sph: "+6.50", cyl: "-2.25" },
  "+6.00_-2.50": { sph: "+6.50", cyl: "-2.75" },
  
  "+6.25_-0.50": { sph: "+6.50", cyl: "" },
  "+6.25_-0.75": { sph: "+7.00", cyl: "-0.75" },
  "+6.25_-1.00": { sph: "+7.00", cyl: "-0.75" },
  "+6.25_-1.25": { sph: "+6.50", cyl: "-1.25" },
  "+6.25_-1.50": { sph: "+7.00", cyl: "-1.25" },
  "+6.25_-1.75": { sph: "+6.50", cyl: "-1.75" },
  "+6.25_-2.00": { sph: "+7.00", cyl: "-1.75" },
  "+6.25_-2.25": { sph: "+6.50", cyl: "-2.25" },
  "+6.25_-2.50": { sph: "+6.50", cyl: "-2.75" },
  
  "+6.50_-0.50": { sph: "+7.00", cyl: "" },
  "+6.50_-0.75": { sph: "+7.00", cyl: "-0.75" },
  "+6.50_-1.00": { sph: "+7.00", cyl: "-0.75" },
  "+6.50_-1.25": { sph: "+7.00", cyl: "-1.25" },
  "+6.50_-1.50": { sph: "+7.00", cyl: "-1.25" },
  "+6.50_-1.75": { sph: "+7.00", cyl: "-1.75" },
  "+6.50_-2.00": { sph: "+7.00", cyl: "-1.75" },
  "+6.50_-2.25": { sph: "+7.00", cyl: "-2.25" },
  "+6.50_-2.50": { sph: "+7.00", cyl: "-2.75" },
  
  "+6.75_-0.50": { sph: "+7.00", cyl: "" },
  "+6.75_-0.75": { sph: "+7.50", cyl: "-0.75" },
  "+6.75_-1.00": { sph: "+7.00", cyl: "-1.25" },
  "+6.75_-1.25": { sph: "+7.50", cyl: "-1.25" },
  "+6.75_-1.50": { sph: "+7.50", cyl: "-1.25" },
  "+6.75_-1.75": { sph: "+7.00", cyl: "-1.75" },
  "+6.75_-2.00": { sph: "+7.50", cyl: "-1.75" },
  "+6.75_-2.25": { sph: "+7.00", cyl: "-2.25" },
  "+6.75_-2.50": { sph: "+7.50", cyl: "-2.75" },
  
  "+7.00_-0.50": { sph: "+7.75", cyl: "" },
  "+7.00_-0.75": { sph: "+7.50", cyl: "-0.75" },
  "+7.00_-1.00": { sph: "+8.00", cyl: "-0.75" },
  "+7.00_-1.25": { sph: "+7.50", cyl: "-1.25" },
  "+7.00_-1.50": { sph: "+8.00", cyl: "-1.25" },
  "+7.00_-1.75": { sph: "+8.00", cyl: "-1.75" },
  "+7.00_-2.00": { sph: "+7.50", cyl: "-2.25" },
  "+7.00_-2.25": { sph: "+8.00", cyl: "-2.25" },
  "+7.00_-2.50": { sph: "+7.50", cyl: "-2.75" },
  
  "+7.25_-0.50": { sph: "+8.00", cyl: "" },
  "+7.25_-0.75": { sph: "+8.00", cyl: "-0.75" },
  "+7.25_-1.00": { sph: "+8.00", cyl: "-0.75" },
  "+7.25_-1.25": { sph: "+8.00", cyl: "-1.25" },
  "+7.25_-1.50": { sph: "+8.00", cyl: "-1.25" },
  "+7.25_-1.75": { sph: "+8.00", cyl: "-1.75" },
  "+7.25_-2.00": { sph: "+8.00", cyl: "-2.25" },
  "+7.25_-2.25": { sph: "+8.00", cyl: "-2.25" },
  "+7.25_-2.50": { sph: "+8.00", cyl: "-2.75" },
  
  "+7.50_-0.50": { sph: "+8.00", cyl: "" },
  "+7.50_-0.75": { sph: "+8.00", cyl: "-0.75" },
  "+7.50_-1.00": { sph: "+8.50", cyl: "-1.25" },
  "+7.50_-1.25": { sph: "+8.00", cyl: "-1.25" },
  "+7.50_-1.50": { sph: "+8.50", cyl: "-1.75" },
  "+7.50_-1.75": { sph: "+8.00", cyl: "-1.75" },
  "+7.50_-2.00": { sph: "+8.50", cyl: "-2.25" },
  "+7.50_-2.25": { sph: "+8.50", cyl: "-2.75" },
  "+7.50_-2.50": { sph: "+8.00", cyl: "-2.75" },
  
  "+7.75_-0.50": { sph: "+8.50", cyl: "" },
  "+7.75_-0.75": { sph: "+8.50", cyl: "-0.75" },
  "+7.75_-1.00": { sph: "+8.50", cyl: "-1.25" },
  "+7.75_-1.25": { sph: "+8.50", cyl: "-1.25" },
  "+7.75_-1.50": { sph: "+8.50", cyl: "-1.75" },
  "+7.75_-1.75": { sph: "+8.50", cyl: "-1.75" },
  "+7.75_-2.00": { sph: "+8.50", cyl: "-2.25" },
  "+7.75_-2.25": { sph: "+8.50", cyl: "-2.25" },
  "+7.75_-2.50": { sph: "+8.50", cyl: "-2.75" }
};

const CONVERSION_TABLE_MYOPES = {
  "0.00_-0.50": { sph: "-0.25", cyl: "" },
  "0.00_-0.75": { sph: "Plan", cyl: "-0.75" },
  "0.00_-1.00": { sph: "-0.25", cyl: "-0.75" },
  "0.00_-1.25": { sph: "Plan", cyl: "-1.25" },
  "0.00_-1.50": { sph: "-0.25", cyl: "-1.25" },
  "0.00_-1.75": { sph: "Plan", cyl: "-1.75" },
  "0.00_-2.00": { sph: "-0.25", cyl: "-1.75" },
  "0.00_-2.25": { sph: "Plan", cyl: "-2.25" },
  "0.00_-2.50": { sph: "Plan", cyl: "-2.25" },
  "0.00_-2.75": { sph: "-0.25", cyl: "-2.75" },
  "0.00_-3.00": { sph: "-0.25", cyl: "-2.75" },
  
  "-0.25_-0.50": { sph: "-0.50", cyl: "" },
  "-0.25_-0.75": { sph: "-0.25", cyl: "-0.75" },
  "-0.25_-1.00": { sph: "-0.50", cyl: "-0.75" },
  "-0.25_-1.25": { sph: "-0.25", cyl: "-1.25" },
  "-0.25_-1.50": { sph: "-0.50", cyl: "-1.25" },
  "-0.25_-1.75": { sph: "-0.25", cyl: "-1.75" },
  "-0.25_-2.00": { sph: "-0.50", cyl: "-1.75" },
  "-0.25_-2.25": { sph: "-0.25", cyl: "-2.25" },
  "-0.25_-2.50": { sph: "-0.50", cyl: "-2.25" },
  "-0.25_-2.75": { sph: "-0.25", cyl: "-2.75" },
  "-0.25_-3.00": { sph: "-0.50", cyl: "-2.75" },
  
  "-0.50_-0.50": { sph: "-0.75", cyl: "" },
  "-0.50_-0.75": { sph: "-0.50", cyl: "-0.75" },
  "-0.50_-1.00": { sph: "-0.75", cyl: "-0.75" },
  "-0.50_-1.25": { sph: "-0.50", cyl: "-1.25" },
  "-0.50_-1.50": { sph: "-0.75", cyl: "-1.25" },
  "-0.50_-1.75": { sph: "-0.50", cyl: "-1.75" },
  "-0.50_-2.00": { sph: "-0.75", cyl: "-1.75" },
  "-0.50_-2.25": { sph: "-0.50", cyl: "-2.25" },
  "-0.50_-2.50": { sph: "-0.75", cyl: "-2.25" },
  "-0.50_-2.75": { sph: "-0.50", cyl: "-2.75" },
  "-0.50_-3.00": { sph: "-0.75", cyl: "-2.75" },
  
  "-0.75_-0.50": { sph: "-1.00", cyl: "" },
  "-0.75_-0.75": { sph: "-0.75", cyl: "-0.75" },
  "-0.75_-1.00": { sph: "-1.00", cyl: "-0.75" },
  "-0.75_-1.25": { sph: "-0.75", cyl: "-1.25" },
  "-0.75_-1.50": { sph: "-1.00", cyl: "-1.25" },
  "-0.75_-1.75": { sph: "-0.75", cyl: "-1.75" },
  "-0.75_-2.00": { sph: "-1.00", cyl: "-1.75" },
  "-0.75_-2.25": { sph: "-0.75", cyl: "-2.25" },
  "-0.75_-2.50": { sph: "-1.00", cyl: "-2.25" },
  "-0.75_-2.75": { sph: "-0.75", cyl: "-2.75" },
  "-0.75_-3.00": { sph: "-1.00", cyl: "-2.75" },
  
  "-1.00_-0.50": { sph: "-1.25", cyl: "" },
  "-1.00_-0.75": { sph: "-1.00", cyl: "-0.75" },
  "-1.00_-1.00": { sph: "-1.25", cyl: "-0.75" },
  "-1.00_-1.25": { sph: "-1.00", cyl: "-1.25" },
  "-1.00_-1.50": { sph: "-1.25", cyl: "-1.25" },
  "-1.00_-1.75": { sph: "-1.00", cyl: "-1.75" },
  "-1.00_-2.00": { sph: "-1.25", cyl: "-1.75" },
  "-1.00_-2.25": { sph: "-1.00", cyl: "-2.25" },
  "-1.00_-2.50": { sph: "-1.25", cyl: "-2.25" },
  "-1.00_-2.75": { sph: "-1.00", cyl: "-2.75" },
  "-1.00_-3.00": { sph: "-1.00", cyl: "-2.75" },
  
  "-1.25_-0.50": { sph: "-1.50", cyl: "" },
  "-1.25_-0.75": { sph: "-1.25", cyl: "-0.75" },
  "-1.25_-1.00": { sph: "-1.50", cyl: "-0.75" },
  "-1.25_-1.25": { sph: "-1.25", cyl: "-1.25" },
  "-1.25_-1.50": { sph: "-1.50", cyl: "-1.25" },
  "-1.25_-1.75": { sph: "-1.50", cyl: "-1.75" },
  "-1.25_-2.00": { sph: "-1.25", cyl: "-2.25" },
  "-1.25_-2.25": { sph: "-1.50", cyl: "-2.25" },
  "-1.25_-2.50": { sph: "-1.25", cyl: "-2.75" },
  
  "-1.50_-0.50": { sph: "-1.75", cyl: "" },
  "-1.50_-0.75": { sph: "-1.50", cyl: "-0.75" },
  "-1.50_-1.00": { sph: "-1.75", cyl: "-0.75" },
  "-1.50_-1.25": { sph: "-1.50", cyl: "-1.25" },
  "-1.50_-1.50": { sph: "-1.75", cyl: "-1.25" },
  "-1.50_-1.75": { sph: "-1.50", cyl: "-1.75" },
  "-1.50_-2.00": { sph: "-1.75", cyl: "-1.75" },
  "-1.50_-2.25": { sph: "-1.50", cyl: "-2.25" },
  "-1.50_-2.50": { sph: "-1.75", cyl: "-2.25" },
  "-1.50_-2.75": { sph: "-1.50", cyl: "-2.75" },
  
  "-1.75_-0.50": { sph: "-2.00", cyl: "" },
  "-1.75_-0.75": { sph: "-1.75", cyl: "-0.75" },
  "-1.75_-1.00": { sph: "-2.00", cyl: "-0.75" },
  "-1.75_-1.25": { sph: "-1.75", cyl: "-1.25" },
  "-1.75_-1.50": { sph: "-2.00", cyl: "-1.25" },
  "-1.75_-1.75": { sph: "-2.00", cyl: "-1.75" },
  "-1.75_-2.00": { sph: "-1.75", cyl: "-2.25" },
  "-1.75_-2.25": { sph: "-2.00", cyl: "-2.25" },
  "-1.75_-2.50": { sph: "-1.75", cyl: "-2.75" },
  
  "-2.00_-0.50": { sph: "-2.25", cyl: "" },
  "-2.00_-0.75": { sph: "-2.00", cyl: "-0.75" },
  "-2.00_-1.00": { sph: "-2.25", cyl: "-0.75" },
  "-2.00_-1.25": { sph: "-2.00", cyl: "-1.25" },
  "-2.00_-1.50": { sph: "-2.25", cyl: "-1.25" },
  "-2.00_-1.75": { sph: "-2.00", cyl: "-1.75" },
  "-2.00_-2.00": { sph: "-2.25", cyl: "-1.75" },
  "-2.00_-2.25": { sph: "-2.00", cyl: "-2.25" },
  "-2.00_-2.50": { sph: "-2.25", cyl: "-2.25" },
  "-2.00_-2.75": { sph: "-2.00", cyl: "-2.75" },
  
  "-2.25_-0.50": { sph: "-2.50", cyl: "" },
  "-2.25_-0.75": { sph: "-2.25", cyl: "-0.75" },
  "-2.25_-1.00": { sph: "-2.50", cyl: "-0.75" },
  "-2.25_-1.25": { sph: "-2.25", cyl: "-1.25" },
  "-2.25_-1.50": { sph: "-2.50", cyl: "-1.25" },
  "-2.25_-1.75": { sph: "-2.50", cyl: "-1.75" },
  "-2.25_-2.00": { sph: "-2.25", cyl: "-2.25" },
  "-2.25_-2.25": { sph: "-2.50", cyl: "-2.25" },
  "-2.25_-2.50": { sph: "-2.25", cyl: "-2.75" },
  
  "-2.50_-0.50": { sph: "-2.75", cyl: "" },
  "-2.50_-0.75": { sph: "-2.50", cyl: "-0.75" },
  "-2.50_-1.00": { sph: "-2.75", cyl: "-0.75" },
  "-2.50_-1.25": { sph: "-2.50", cyl: "-1.25" },
  "-2.50_-1.50": { sph: "-2.75", cyl: "-1.25" },
  "-2.50_-1.75": { sph: "-2.50", cyl: "-1.75" },
  "-2.50_-2.00": { sph: "-2.75", cyl: "-1.75" },
  "-2.50_-2.25": { sph: "-2.50", cyl: "-2.25" },
  "-2.50_-2.50": { sph: "-2.75", cyl: "-2.25" },
  
  "-2.75_-0.50": { sph: "-3.00", cyl: "" },
  "-2.75_-0.75": { sph: "-2.75", cyl: "-0.75" },
  "-2.75_-1.00": { sph: "-3.00", cyl: "-0.75" },
  "-2.75_-1.25": { sph: "-2.75", cyl: "-1.25" },
  "-2.75_-1.50": { sph: "-3.00", cyl: "-1.25" },
  "-2.75_-1.75": { sph: "-2.75", cyl: "-1.75" },
  "-2.75_-2.00": { sph: "-3.00", cyl: "-1.75" },
  "-2.75_-2.25": { sph: "-2.75", cyl: "-2.25" },
  "-2.75_-2.50": { sph: "-3.00", cyl: "-2.25" },
  "-2.75_-2.75": { sph: "-2.75", cyl: "-2.75" },
  
  "-3.00_-0.50": { sph: "-3.25", cyl: "" },
  "-3.00_-0.75": { sph: "-3.00", cyl: "-0.75" },
  "-3.00_-1.00": { sph: "-3.25", cyl: "-0.75" },
  "-3.00_-1.25": { sph: "-3.00", cyl: "-1.25" },
  "-3.00_-1.50": { sph: "-3.25", cyl: "-1.25" },
  "-3.00_-1.75": { sph: "-3.00", cyl: "-1.75" },
  "-3.00_-2.00": { sph: "-3.25", cyl: "-1.75" },
  "-3.00_-2.25": { sph: "-3.00", cyl: "-2.25" },
  "-3.00_-2.50": { sph: "-3.25", cyl: "-2.25" },
  "-3.00_-2.75": { sph: "-3.25", cyl: "-2.75" },
  
  "-3.25_-0.50": { sph: "-3.50", cyl: "" },
  "-3.25_-0.75": { sph: "-3.50", cyl: "-0.75" },
  "-3.25_-1.00": { sph: "-3.25", cyl: "-1.25" },
  "-3.25_-1.25": { sph: "-3.50", cyl: "-1.25" },
  "-3.25_-1.50": { sph: "-3.25", cyl: "-1.75" },
  "-3.25_-1.75": { sph: "-3.50", cyl: "-1.75" },
  "-3.25_-2.00": { sph: "-3.25", cyl: "-2.25" },
  "-3.25_-2.25": { sph: "-3.50", cyl: "-2.25" },
  "-3.25_-2.50": { sph: "-3.25", cyl: "-2.75" },
  
  "-3.50_-0.50": { sph: "-3.50", cyl: "" },
  "-3.50_-0.75": { sph: "-3.75", cyl: "-0.75" },
  "-3.50_-1.00": { sph: "-3.50", cyl: "-1.25" },
  "-3.50_-1.25": { sph: "-3.75", cyl: "-1.25" },
  "-3.50_-1.50": { sph: "-3.50", cyl: "-1.75" },
  "-3.50_-1.75": { sph: "-3.75", cyl: "-1.75" },
  "-3.50_-2.00": { sph: "-3.75", cyl: "-2.25" },
  "-3.50_-2.25": { sph: "-3.50", cyl: "-2.25" },
  "-3.50_-2.50": { sph: "-3.75", cyl: "-2.25" },
  
  "-3.75_-0.50": { sph: "-3.50", cyl: "" },
  "-3.75_-0.75": { sph: "-4.00", cyl: "-0.75" },
  "-3.75_-1.00": { sph: "-3.75", cyl: "-1.25" },
  "-3.75_-1.25": { sph: "-4.00", cyl: "-1.25" },
  "-3.75_-1.50": { sph: "-3.75", cyl: "-1.75" },
  "-3.75_-1.75": { sph: "-4.00", cyl: "-1.75" },
  "-3.75_-2.00": { sph: "-3.75", cyl: "-2.25" },
  "-3.75_-2.25": { sph: "-4.00", cyl: "-2.25" },
  
  "-4.00_-0.50": { sph: "-4.00", cyl: "" },
  "-4.00_-0.75": { sph: "-3.75", cyl: "-0.75" },
  "-4.00_-1.00": { sph: "-4.00", cyl: "-0.75" },
  "-4.00_-1.25": { sph: "-3.75", cyl: "-1.25" },
  "-4.00_-1.50": { sph: "-4.00", cyl: "-1.25" },
  "-4.00_-1.75": { sph: "-3.75", cyl: "-1.75" },
  "-4.00_-2.00": { sph: "-4.00", cyl: "-1.75" },
  "-4.00_-2.25": { sph: "-3.75", cyl: "-2.25" },
  "-4.00_-2.50": { sph: "-4.00", cyl: "-2.25" },
  "-4.00_-2.75": { sph: "-3.75", cyl: "-2.75" },
  
  "-4.25_-0.50": { sph: "-4.25", cyl: "" },
  "-4.25_-0.75": { sph: "-4.00", cyl: "-0.75" },
  "-4.25_-1.00": { sph: "-4.25", cyl: "-0.75" },
  "-4.25_-1.25": { sph: "-4.00", cyl: "-1.25" },
  "-4.25_-1.50": { sph: "-4.25", cyl: "-1.25" },
  "-4.25_-1.75": { sph: "-4.25", cyl: "-1.75" },
  "-4.25_-2.00": { sph: "-4.25", cyl: "-1.75" },
  "-4.25_-2.25": { sph: "-4.00", cyl: "-2.25" },
  "-4.25_-2.50": { sph: "-4.25", cyl: "-2.25" },
  "-4.25_-2.75": { sph: "-4.00", cyl: "-2.75" },
  
  "-4.50_-0.50": { sph: "-4.50", cyl: "" },
  "-4.50_-0.75": { sph: "-4.25", cyl: "-0.75" },
  "-4.50_-1.00": { sph: "-4.50", cyl: "-0.75" },
  "-4.50_-1.25": { sph: "-4.25", cyl: "-1.25" },
  "-4.50_-1.50": { sph: "-4.50", cyl: "-1.25" },
  "-4.50_-1.75": { sph: "-4.50", cyl: "-1.75" },
  "-4.50_-2.00": { sph: "-4.50", cyl: "-1.75" },
  "-4.50_-2.25": { sph: "-4.25", cyl: "-2.25" },
  "-4.50_-2.50": { sph: "-4.50", cyl: "-2.25" },
  "-4.50_-2.75": { sph: "-4.25", cyl: "-2.75" },
  
  "-4.75_-0.50": { sph: "-4.75", cyl: "" },
  "-4.75_-0.75": { sph: "-4.50", cyl: "-0.75" },
  "-4.75_-1.00": { sph: "-4.75", cyl: "-0.75" },
  "-4.75_-1.25": { sph: "-4.75", cyl: "-1.25" },
  "-4.75_-1.50": { sph: "-4.50", cyl: "-1.75" },
  "-4.75_-1.75": { sph: "-4.75", cyl: "-1.75" },
  "-4.75_-2.00": { sph: "-4.50", cyl: "-2.25" },
  "-4.75_-2.25": { sph: "-4.75", cyl: "-2.25" },
  "-4.75_-2.50": { sph: "-4.75", cyl: "-2.75" },
  
  "-5.00_-0.50": { sph: "-5.00", cyl: "" },
  "-5.00_-0.75": { sph: "-4.75", cyl: "-0.75" },
  "-5.00_-1.00": { sph: "-4.75", cyl: "-1.25" },
  "-5.00_-1.25": { sph: "-5.00", cyl: "-1.25" },
  "-5.00_-1.50": { sph: "-4.75", cyl: "-1.75" },
  "-5.00_-1.75": { sph: "-5.00", cyl: "-1.75" },
  "-5.00_-2.00": { sph: "-4.75", cyl: "-2.25" },
  "-5.00_-2.25": { sph: "-5.00", cyl: "-2.25" },
  "-5.00_-2.50": { sph: "-4.75", cyl: "-2.75" },
  
  "-5.25_-0.50": { sph: "-5.25", cyl: "" },
  "-5.25_-0.75": { sph: "-5.25", cyl: "-0.75" },
  "-5.25_-1.00": { sph: "-5.00", cyl: "-1.25" },
  "-5.25_-1.25": { sph: "-5.25", cyl: "-1.25" },
  "-5.25_-1.50": { sph: "-5.00", cyl: "-1.75" },
  "-5.25_-1.75": { sph: "-5.25", cyl: "-1.75" },
  "-5.25_-2.00": { sph: "-5.25", cyl: "-2.25" },
  "-5.25_-2.25": { sph: "-5.00", cyl: "-2.75" },
  "-5.25_-2.50": { sph: "-5.25", cyl: "-2.75" },
  
  "-5.50_-0.50": { sph: "-5.25", cyl: "" },
  "-5.50_-0.75": { sph: "-5.50", cyl: "-0.75" },
  "-5.50_-1.00": { sph: "-5.25", cyl: "-1.25" },
  "-5.50_-1.25": { sph: "-5.50", cyl: "-1.25" },
  "-5.50_-1.50": { sph: "-5.25", cyl: "-1.75" },
  "-5.50_-1.75": { sph: "-5.50", cyl: "-1.75" },
  "-5.50_-2.00": { sph: "-5.25", cyl: "-2.25" },
  "-5.50_-2.25": { sph: "-5.50", cyl: "-2.25" },
  "-5.50_-2.50": { sph: "-5.25", cyl: "-2.75" },
  
  "-5.75_-0.50": { sph: "-5.50", cyl: "" },
  "-5.75_-0.75": { sph: "-5.75", cyl: "-0.75" },
  "-5.75_-1.00": { sph: "-5.50", cyl: "-1.25" },
  "-5.75_-1.25": { sph: "-5.75", cyl: "-1.25" },
  "-5.75_-1.50": { sph: "-5.50", cyl: "-1.75" },
  "-5.75_-1.75": { sph: "-5.75", cyl: "-1.75" },
  "-5.75_-2.00": { sph: "-5.50", cyl: "-2.25" },
  "-5.75_-2.25": { sph: "-5.75", cyl: "-2.25" },
  "-5.75_-2.50": { sph: "-5.50", cyl: "-2.75" },
  
  "-6.00_-0.50": { sph: "-5.75", cyl: "" },
  "-6.00_-0.75": { sph: "-5.50", cyl: "-0.75" },
  "-6.00_-1.00": { sph: "-5.75", cyl: "-0.75" },
  "-6.00_-1.25": { sph: "-5.50", cyl: "-1.25" },
  "-6.00_-1.50": { sph: "-5.75", cyl: "-1.25" },
  "-6.00_-1.75": { sph: "-5.75", cyl: "-1.75" },
  "-6.00_-2.00": { sph: "-5.50", cyl: "-2.25" },
  "-6.00_-2.25": { sph: "-5.75", cyl: "-2.25" },
  "-6.00_-2.50": { sph: "-5.75", cyl: "-2.75" },
  
  "-6.25_-0.50": { sph: "-6.00", cyl: "" },
  "-6.25_-0.75": { sph: "-5.75", cyl: "-0.75" },
  "-6.25_-1.00": { sph: "-6.00", cyl: "-0.75" },
  "-6.25_-1.25": { sph: "-5.75", cyl: "-1.25" },
  "-6.25_-1.50": { sph: "-6.00", cyl: "-1.25" },
  "-6.25_-1.75": { sph: "-5.75", cyl: "-1.75" },
  "-6.25_-2.00": { sph: "-6.00", cyl: "-1.75" },
  "-6.25_-2.25": { sph: "-5.75", cyl: "-2.25" },
  "-6.25_-2.50": { sph: "-5.75", cyl: "-2.75" },
  
  "-6.50_-0.50": { sph: "-6.00", cyl: "" },
  "-6.50_-0.75": { sph: "-6.00", cyl: "-0.75" },
  "-6.50_-1.00": { sph: "-6.00", cyl: "-1.25" },
  "-6.50_-1.25": { sph: "-6.00", cyl: "-1.25" },
  "-6.50_-1.50": { sph: "-6.00", cyl: "-1.75" },
  "-6.50_-1.75": { sph: "-6.00", cyl: "-1.75" },
  "-6.50_-2.00": { sph: "-6.00", cyl: "-2.25" },
  "-6.50_-2.25": { sph: "-6.00", cyl: "-2.25" },
  "-6.50_-2.50": { sph: "-6.00", cyl: "-2.75" },
  "-6.50_-2.75": { sph: "-6.00", cyl: "-2.75" },
  "-6.50_-3.00": { sph: "-6.00", cyl: "-2.75" },
  
  "-6.75_-0.50": { sph: "-6.50", cyl: "" },
  "-6.75_-0.75": { sph: "-6.00", cyl: "-1.25" },
  "-6.75_-1.00": { sph: "-6.00", cyl: "-1.25" },
  "-6.75_-1.25": { sph: "-6.50", cyl: "-1.25" },
  "-6.75_-1.50": { sph: "-6.00", cyl: "-1.75" },
  "-6.75_-1.75": { sph: "-6.50", cyl: "-1.75" },
  "-6.75_-2.00": { sph: "-6.00", cyl: "-2.25" },
  "-6.75_-2.25": { sph: "-6.50", cyl: "-2.25" },
  "-6.75_-2.50": { sph: "-6.00", cyl: "-2.75" },
  "-6.75_-2.75": { sph: "-6.50", cyl: "-2.75" },
  "-6.75_-3.00": { sph: "-6.50", cyl: "-2.75" },
  
  "-7.00_-0.50": { sph: "-6.50", cyl: "" },
  "-7.00_-0.75": { sph: "-6.50", cyl: "-0.75" },
  "-7.00_-1.00": { sph: "-6.50", cyl: "-1.25" },
  "-7.00_-1.25": { sph: "-6.50", cyl: "-1.25" },
  "-7.00_-1.50": { sph: "-6.50", cyl: "-1.75" },
  "-7.00_-1.75": { sph: "-6.50", cyl: "-1.75" },
  "-7.00_-2.00": { sph: "-6.50", cyl: "-2.25" },
  "-7.00_-2.25": { sph: "-6.50", cyl: "-2.25" },
  "-7.00_-2.50": { sph: "-6.50", cyl: "-2.75" },
  "-7.00_-2.75": { sph: "-6.50", cyl: "-2.75" },
  "-7.00_-3.00": { sph: "-6.50", cyl: "-2.75" },
  
  "-7.25_-0.50": { sph: "-6.50", cyl: "" },
  "-7.25_-0.75": { sph: "-7.00", cyl: "-0.75" },
  "-7.25_-1.00": { sph: "-6.50", cyl: "-1.25" },
  "-7.25_-1.25": { sph: "-7.00", cyl: "-1.25" },
  "-7.25_-1.50": { sph: "-6.50", cyl: "-1.75" },
  "-7.25_-1.75": { sph: "-6.50", cyl: "-1.75" },
  "-7.25_-2.00": { sph: "-7.00", cyl: "-2.25" },
  "-7.25_-2.25": { sph: "-6.50", cyl: "-2.75" },
  "-7.25_-2.50": { sph: "-7.00", cyl: "-2.75" },
  
  "-7.50_-0.50": { sph: "-7.00", cyl: "" },
  "-7.50_-0.75": { sph: "-7.00", cyl: "-0.75" },
  "-7.50_-1.00": { sph: "-7.00", cyl: "-1.25" },
  "-7.50_-1.25": { sph: "-7.00", cyl: "-1.25" },
  "-7.50_-1.50": { sph: "-7.00", cyl: "-1.75" },
  "-7.50_-1.75": { sph: "-7.00", cyl: "-1.75" },
  "-7.50_-2.00": { sph: "-7.00", cyl: "-2.25" },
  "-7.50_-2.25": { sph: "-7.00", cyl: "-2.25" },
  "-7.50_-2.50": { sph: "-7.00", cyl: "-2.75" },
  
  "-7.75_-0.50": { sph: "-7.00", cyl: "" },
  "-7.75_-0.75": { sph: "-7.00", cyl: "-0.75" },
  "-7.75_-1.00": { sph: "-7.00", cyl: "-1.25" },
  "-7.75_-1.25": { sph: "-7.00", cyl: "-1.25" },
  "-7.75_-1.50": { sph: "-7.00", cyl: "-1.75" },
  "-7.75_-1.75": { sph: "-7.00", cyl: "-1.75" },
  "-7.75_-2.00": { sph: "-7.00", cyl: "-2.25" },
  "-7.75_-2.25": { sph: "-7.00", cyl: "-2.25" },
  "-7.75_-2.50": { sph: "-7.00", cyl: "-2.75" },
  
  "-8.00_-0.50": { sph: "-7.50", cyl: "" },
  "-8.00_-0.75": { sph: "-7.00", cyl: "-1.25" },
  "-8.00_-1.00": { sph: "-7.00", cyl: "-1.25" },
  "-8.00_-1.25": { sph: "-7.50", cyl: "-1.25" },
  "-8.00_-1.50": { sph: "-7.00", cyl: "-1.75" },
  "-8.00_-1.75": { sph: "-7.50", cyl: "-1.75" },
  "-8.00_-2.00": { sph: "-7.50", cyl: "-2.25" },
  "-8.00_-2.25": { sph: "-7.00", cyl: "-2.75" },
  "-8.00_-2.50": { sph: "-7.50", cyl: "-2.75" },
  
  "-8.25_-0.50": { sph: "-7.50", cyl: "" },
  "-8.25_-0.75": { sph: "-7.50", cyl: "-0.75" },
  "-8.25_-1.00": { sph: "-7.50", cyl: "-1.25" },
  "-8.25_-1.25": { sph: "-7.50", cyl: "-1.25" },
  "-8.25_-1.50": { sph: "-7.50", cyl: "-1.75" },
  "-8.25_-1.75": { sph: "-7.50", cyl: "-1.75" },
  "-8.25_-2.00": { sph: "-7.50", cyl: "-2.25" },
  "-8.25_-2.25": { sph: "-7.50", cyl: "-2.25" },
  "-8.25_-2.50": { sph: "-7.50", cyl: "-2.75" },
  
  "-8.50_-0.50": { sph: "-7.50", cyl: "" },
  "-8.50_-0.75": { sph: "-8.00", cyl: "-0.75" },
  "-8.50_-1.00": { sph: "-7.50", cyl: "-1.25" },
  "-8.50_-1.25": { sph: "-8.00", cyl: "-1.25" },
  "-8.50_-1.50": { sph: "-7.50", cyl: "-1.75" },
  "-8.50_-1.75": { sph: "-7.50", cyl: "-1.75" },
  "-8.50_-2.00": { sph: "-8.00", cyl: "-2.25" },
  "-8.50_-2.25": { sph: "-7.50", cyl: "-2.75" },
  "-8.50_-2.50": { sph: "-8.00", cyl: "-2.75" },
  
  "-8.75_-0.50": { sph: "-8.00", cyl: "" },
  "-8.75_-0.75": { sph: "-8.00", cyl: "-0.75" },
  "-8.75_-1.00": { sph: "-8.00", cyl: "-1.25" },
  "-8.75_-1.25": { sph: "-8.00", cyl: "-1.25" },
  "-8.75_-1.50": { sph: "-8.00", cyl: "-1.75" },
  "-8.75_-1.75": { sph: "-8.00", cyl: "-1.75" },
  "-8.75_-2.00": { sph: "-8.00", cyl: "-2.25" },
  "-8.75_-2.25": { sph: "-8.00", cyl: "-2.25" },
  "-8.75_-2.50": { sph: "-8.00", cyl: "-2.75" },
  
  "-9.00_-0.50": { sph: "-8.00", cyl: "" },
  "-9.00_-0.75": { sph: "-8.00", cyl: "-0.75" },
  "-9.00_-1.00": { sph: "-8.00", cyl: "-1.25" },
  "-9.00_-1.25": { sph: "-8.00", cyl: "-1.25" },
  "-9.00_-1.50": { sph: "-8.00", cyl: "-1.75" },
  "-9.00_-1.75": { sph: "-8.00", cyl: "-1.75" },
  "-9.00_-2.00": { sph: "-8.00", cyl: "-2.25" },
  "-9.00_-2.25": { sph: "-8.00", cyl: "-2.25" },
  "-9.00_-2.50": { sph: "-8.00", cyl: "-2.75" },
  
  "-9.25_-0.50": { sph: "-8.50", cyl: "" },
  "-9.25_-0.75": { sph: "-8.00", cyl: "-1.25" },
  "-9.25_-1.00": { sph: "-8.50", cyl: "-1.25" },
  "-9.25_-1.25": { sph: "-8.50", cyl: "-1.25" },
  "-9.25_-1.50": { sph: "-8.00", cyl: "-1.75" },
  "-9.25_-1.75": { sph: "-8.50", cyl: "-1.75" },
  "-9.25_-2.00": { sph: "-8.00", cyl: "-2.25" },
  "-9.25_-2.25": { sph: "-8.00", cyl: "-2.75" },
  "-9.25_-2.50": { sph: "-8.50", cyl: "-2.75" },
  
  "-9.50_-0.50": { sph: "-8.50", cyl: "" },
  "-9.50_-0.75": { sph: "-8.50", cyl: "-0.75" },
  "-9.50_-1.00": { sph: "-8.50", cyl: "-1.25" },
  "-9.50_-1.25": { sph: "-8.50", cyl: "-1.25" },
  "-9.50_-1.50": { sph: "-8.50", cyl: "-1.75" },
  "-9.50_-1.75": { sph: "-8.50", cyl: "-1.75" },
  "-9.50_-2.00": { sph: "-8.50", cyl: "-2.25" },
  "-9.50_-2.25": { sph: "-8.50", cyl: "-2.25" },
  "-9.50_-2.50": { sph: "-8.50", cyl: "-2.75" },
  
  "-9.75_-0.50": { sph: "-9.00", cyl: "" },
  "-9.75_-0.75": { sph: "-9.00", cyl: "-0.75" },
  "-9.75_-1.00": { sph: "-8.50", cyl: "-1.25" },
  "-9.75_-1.25": { sph: "-9.00", cyl: "-1.25" },
  "-9.75_-1.50": { sph: "-8.50", cyl: "-1.75" },
  "-9.75_-1.75": { sph: "-8.50", cyl: "-1.75" },
  "-9.75_-2.00": { sph: "-9.00", cyl: "-2.25" },
  "-9.75_-2.25": { sph: "-9.00", cyl: "-2.75" },
  "-9.75_-2.50": { sph: "-8.50", cyl: "-2.75" },
  
  "-10.00_-0.50": { sph: "-9.00", cyl: "" },
  "-10.00_-0.75": { sph: "-10.00", cyl: "-0.75" },
  "-10.00_-1.00": { sph: "-9.00", cyl: "-1.25" },
  "-10.00_-1.25": { sph: "-9.00", cyl: "-1.25" },
  "-10.00_-1.50": { sph: "-9.00", cyl: "-1.75" },
  "-10.00_-1.75": { sph: "-9.00", cyl: "-1.75" },
  "-10.00_-2.00": { sph: "-9.00", cyl: "-2.25" },
  "-10.00_-2.25": { sph: "-9.00", cyl: "-2.25" },
  "-10.00_-2.50": { sph: "-9.00", cyl: "-2.75" }
};

// Fonction qui cherche dans le tableau de conversion
const convertirAvecTableau = (sphereLunettes, cylindreLunettes) => {
  if (!sphereLunettes) return { sphere: "", cylindre: "", axe: "" };

  let sphVal = parseFloat(sphereLunettes);
  // Handle "Plan" sphere for internal calculation, but keep "Plan" string for output if applicable
  let originalSphereFormatted = sphereLunettes;
  if (sphereLunettes.toLowerCase() === "plan") {
    sphVal = 0;
    originalSphereFormatted = "Plan"; // Keep original string for output
  } else if (isNaN(sphVal)) {
    return { sphere: sphereLunettes, cylindre: cylindreLunettes || "", axe: "" };
  }

  // If no cylinder, return sphere as is
  if (!cylindreLunettes) {
    return { sphere: originalSphereFormatted, cylindre: "", axe: "" };
  }

  const cylVal = parseFloat(cylindreLunettes);
  if (isNaN(cylVal)) return { sphere: originalSphereFormatted, cylindre: cylindreLunettes, axe: "" };

  // --- Apply specific rules as per dialog description ---

  // 1. Cylindre -0.25: effacer le cylindre et l'axe
  if (cylVal === -0.25) {
    return { sphere: originalSphereFormatted, cylindre: "", axe: "" };
  }

  // 2. Cylindre -0.50: équivalent sphérique
  if (cylVal === -0.50 || cylVal === -0.5) {
    const nouvelleSphereBrute = sphVal + (cylVal / 2);
    let nouvelleSphereFormatted;
    if (nouvelleSphereBrute === 0) {
      nouvelleSphereFormatted = "Plan";
    } else {
      nouvelleSphereFormatted = (nouvelleSphereBrute > 0 ? "+" : "") + nouvelleSphereBrute.toFixed(2);
    }
    return { sphere: nouvelleSphereFormatted, cylindre: "", axe: "" };
  }

  // --- For other cylinders, proceed with table lookup (DVO 12mm) ---

  // Round sphere and cylinder to the nearest 0.25 for lookup keys
  const roundedSph = (Math.round(sphVal * 4) / 4);
  const roundedCyl = (Math.round(cylVal * 4) / 4);

  // Format keys as they appear in the CONVERSION_TABLEs
  let sphKeyForTable = (roundedSph === 0) ? "0.00" : ((roundedSph > 0 ? "+" : "") + roundedSph.toFixed(2));
  const cylKeyForTable = roundedCyl.toFixed(2); // Cylinders in tables are like "-0.75"

  const tableKey = `${sphKeyForTable}_${cylKeyForTable}`;

  const table = sphVal > 0 ? CONVERSION_TABLE_HYPERMETROPES : CONVERSION_TABLE_MYOPES;

  if (table[tableKey]) {
    const result = table[tableKey];
    return {
      sphere: result.sph,
      cylindre: result.cyl,
      axe: "" // Axe will be converted separately by convertirAxeLunettesVersLentilles if cyl is present
    };
  }

  // If no specific rule or table entry found, return original values for sphere and cylinder
  // The axe is implicitly not converted if cylinder is not found/converted
  return { sphere: originalSphereFormatted, cylindre: cylindreLunettes, axe: "" };
};

// Fonction de conversion axe selon règle GADS
const convertirAxeLunettesVersLentilles = (axeLunettes, oeil) => {
  if (!axeLunettes) return "";

  const axe = parseInt(axeLunettes);
  if (isNaN(axe)) return axeLunettes;

  // Axes disponibles: 10°, 20°, 70°, 80°, 90°, 100°, 110°, 160°, 170°, 180°
  const axesDisponibles = [10, 20, 70, 80, 90, 100, 110, 160, 170, 180];

  // Si l'axe est déjà disponible, le garder
  if (axesDisponibles.includes(axe)) {
    return axe.toString();
  }

  // Sinon, appliquer la règle GADS
  // Gauche Ajoute 5°, Droit Soustrait 5°
  let axeAjuste = axe;
  if (oeil === "og") {
    axeAjuste = axe + 5;
  } else if (oeil === "od") {
    axeAjuste = axe - 5;
  }

  // S'assurer que l'axe reste dans [0, 180]
  if (axeAjuste > 180) axeAjuste -= 180;
  if (axeAjuste < 0) axeAjuste += 180;

  // Trouver l'axe disponible le plus proche
  const axeProche = axesDisponibles.reduce((prev, curr) => {
    return Math.abs(curr - axeAjuste) < Math.abs(prev - axeAjuste) ? curr : prev;
  });

  return axeProche.toString();
};

export default function LentillesSection({ patientId, patient }) {
  const queryClient = useQueryClient();
  const [showDialog, setShowDialog] = useState(false);
  const [editingPrescription, setEditingPrescription] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);

  const [formData, setFormData] = useState({
    patient_id: patientId,
    date_prescription: new Date().toISOString(),
    od_lentille_id: "",
    od_sphere: "",
    od_cylindre: "",
    od_axe: "",
    od_addition: "",
    od_puissance: "",
    od_rayon: "",
    od_diametre: "",
    og_lentille_id: "",
    og_sphere: "",
    og_cylindre: "",
    og_axe: "",
    og_addition: "",
    og_puissance: "",
    og_rayon: "",
    og_diametre: "",
    notes: ""
  });

  useEffect(() => {
    const loadUser = async () => {
      const user = await base44.auth.me().catch(() => null);
      setCurrentUser(user || { email: 'default@user.com', specialite: 'ophtalmologue' });
    };
    loadUser();
  }, []);

  // Permission logic:
  // - Only ophtalmologue and admin can create/modify prescriptions de lentilles
  // - Everyone can print/email prescriptions de lentilles
  const canEdit = currentUser?.specialite === 'ophtalmologue' || 
                  currentUser?.specialite === 'admin';
  const canPrintOrEmail = true; // Everyone can print/email

  const { data: prescriptions } = useQuery({
    queryKey: ['prescriptions-lentilles', patientId],
    queryFn: async () => {
      const all = await base44.entities.PrescriptionLentille.list('-date_prescription');
      return all.filter(p => p.patient_id === patientId);
    },
    initialData: [],
  });

  const { data: lentilles } = useQuery({
    queryKey: ['lentilles-contact'],
    queryFn: async () => {
      const all = await base44.entities.LentilleContact.list();
      return all.filter(l => l.is_global || l.created_by === currentUser?.email);
    },
    initialData: [],
    enabled: !!currentUser,
  });

  const { data: users } = useQuery({
    queryKey: ['users-for-print'],
    queryFn: () => base44.entities.User.list(),
    initialData: [],
  });

  const { data: examensOrtho } = useQuery({
    queryKey: ['examens-orthoptiste', patientId],
    queryFn: async () => {
      const all = await base44.entities.ExamenOrthoptiste.list('-date_examen');
      return all.filter(e => e.patient_id === patientId);
    },
    initialData: [],
  });

  const createPrescriptionMutation = useMutation({
    mutationFn: (data) => base44.entities.PrescriptionLentille.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['prescriptions-lentilles', patientId] });
      setShowDialog(false);
      resetForm();
    },
  });

  const updatePrescriptionMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.PrescriptionLentille.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['prescriptions-lentilles', patientId] });
      setShowDialog(false);
      resetForm();
    },
  });

  const deletePrescriptionMutation = useMutation({
    mutationFn: (id) => base44.entities.PrescriptionLentille.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['prescriptions-lentilles', patientId] });
    },
  });

  const resetForm = () => {
    setFormData({
      patient_id: patientId,
      date_prescription: new Date().toISOString(),
      od_lentille_id: "",
      od_sphere: "",
      od_cylindre: "",
      od_axe: "",
      od_addition: "",
      od_puissance: "",
      od_rayon: "",
      od_diametre: "",
      og_lentille_id: "",
      og_sphere: "",
      og_cylindre: "",
    og_axe: "",
    og_addition: "",
      og_puissance: "",
      og_rayon: "",
      og_diametre: "",
      notes: ""
    });
    setEditingPrescription(null);
  };

  const handleLentilleChange = (oeil, lentilleId) => {
    const lentille = lentilles.find(l => l.id === lentilleId);
    if (lentille) {
      setFormData(prev => ({
        ...prev,
        [`${oeil}_lentille_id`]: lentilleId,
        [`${oeil}_rayon`]: lentille.rayon || "",
        [`${oeil}_diametre`]: lentille.diametre || ""
      }));
    }
  };

  const copierRefractionTelleQuelle = () => {
    const dernierExamen = examensOrtho.length > 0 ? examensOrtho[0] : null;

    if (!dernierExamen) {
      toast.error("Aucun examen orthoptiste trouvé pour copier les données.");
      return;
    }

    // Copie EXACTE sans aucune modification
    setFormData(prev => ({
      ...prev,
      od_sphere: dernierExamen.ref_subjective_od_sphere || "",
      od_cylindre: dernierExamen.ref_subjective_od_cylindre || "",
      od_axe: dernierExamen.ref_subjective_od_axe || "",
      od_addition: dernierExamen.ref_subjective_od_add || "",
      og_sphere: dernierExamen.ref_subjective_og_sphere || "",
      og_cylindre: dernierExamen.ref_subjective_og_cylindre || "",
      og_axe: dernierExamen.ref_subjective_og_axe || "",
      og_addition: dernierExamen.ref_subjective_og_add || ""
    }));
  };

  const convertirLunettesVersLentilles = () => {
    const dernierExamen = examensOrtho.length > 0 ? examensOrtho[0] : null;

    if (!dernierExamen) {
      toast.error("Aucun examen orthoptiste trouvé pour copier les données.");
      return;
    }

    // Convertir OD
    const odConverted = convertirAvecTableau(
      dernierExamen.ref_subjective_od_sphere,
      dernierExamen.ref_subjective_od_cylindre,
      "od"
    );

    // Convertir l'axe OD si un cylindre résultant de la conversion est présent
    const odAxeConverted = odConverted.cylindre ?
      convertirAxeLunettesVersLentilles(dernierExamen.ref_subjective_od_axe, "od") : "";

    // Convertir OG
    const ogConverted = convertirAvecTableau(
      dernierExamen.ref_subjective_og_sphere,
      dernierExamen.ref_subjective_og_cylindre,
      "og"
    );

    // Convertir l'axe OG si un cylindre résultant de la conversion est présent
    const ogAxeConverted = ogConverted.cylindre ?
      convertirAxeLunettesVersLentilles(dernierExamen.ref_subjective_og_axe, "og") : "";

    setFormData(prev => ({
      ...prev,
      od_sphere: odConverted.sphere || "",
      od_cylindre: odConverted.cylindre || "",
      od_axe: odAxeConverted || "",
      od_addition: dernierExamen.ref_subjective_od_add || "",
      og_sphere: ogConverted.sphere || "",
      og_cylindre: ogConverted.cylindre || "",
      og_axe: ogAxeConverted || "",
      og_addition: dernierExamen.ref_subjective_og_add || ""
    }));
  };

  const handleSave = () => {
    if (editingPrescription) {
      updatePrescriptionMutation.mutate({ id: editingPrescription.id, data: formData });
    } else {
      createPrescriptionMutation.mutate(formData);
    }
  };

  const handleEdit = (prescription) => {
    setEditingPrescription(prescription);
    setFormData({
      patient_id: patientId,
      date_prescription: prescription.date_prescription,
      od_lentille_id: prescription.od_lentille_id || "",
      od_sphere: prescription.od_sphere || "",
      od_cylindre: prescription.od_cylindre || "",
      od_axe: prescription.od_axe || "",
      od_addition: prescription.od_addition || "",
      od_puissance: prescription.od_puissance || "",
      od_rayon: prescription.od_rayon || "",
      od_diametre: prescription.od_diametre || "",
      og_lentille_id: prescription.og_lentille_id || "",
      og_sphere: prescription.og_sphere || "",
      og_cylindre: prescription.og_cylindre || "",
      og_axe: prescription.og_axe || "",
      og_addition: prescription.og_addition || "",
      og_puissance: prescription.og_puissance || "",
      og_rayon: prescription.og_rayon || "",
      og_diametre: prescription.og_diametre || "",
      notes: prescription.notes || ""
    });
    setShowDialog(true);
  };

  const handleDelete = (prescription) => {
    if (!canEdit) return;
    
    const datePrescription = new Date(prescription.date_prescription);
    const maintenant = new Date();
    const differenceHeures = (maintenant - datePrescription) / (1000 * 60 * 60);
    
    if (differenceHeures > 24) {
      toast.error("Impossible de supprimer une prescription de plus de 24 heures");
      return;
    }
    
    if (confirm("Voulez-vous vraiment supprimer cette prescription ?")) {
      deletePrescriptionMutation.mutate(prescription.id);
    }
  };

  const genererHtmlPrescription = (prescription) => {
    const medecin = users.find(u => u.specialite === 'admin' || u.specialite === 'ophtalmologue') || currentUser;
    const entete = medecin?.entete_ordonnance || '';
    const odLentille = lentilles.find(l => l.id === prescription.od_lentille_id);
    const ogLentille = lentilles.find(l => l.id === prescription.og_lentille_id);

    // Vérifier s'il y a des cylindres ou axes
    const hasCylindre = prescription.od_cylindre || prescription.og_cylindre;
    const hasAxe = prescription.od_axe || prescription.og_axe;
    const hasAddition = prescription.od_addition || prescription.og_addition;

    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #ffffff; }
          .header { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333; }
          .header img { max-width: 100%; height: auto; }
          .title { text-align: center; font-size: 24px; font-weight: bold; margin: 30px 0; text-transform: uppercase; }
          .patient-info { margin: 20px 0; padding: 15px; background-color: #f5f5f5; border-radius: 5px; }
          .patient-info p { margin: 5px 0; }
          .prescription { margin: 30px 0; }
          .prescription-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          .prescription-table th, .prescription-table td { border: 1px solid #333; padding: 12px; text-align: center; }
          .prescription-table th { background-color: #e0e0e0; font-weight: bold; }
          .lentille-info { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #666; }
          .signature { margin-top: 60px; text-align: right; }
        </style>
      </head>
      <body>
        <div class="header">
          ${entete ? `<img src="${entete}" alt="En-tête" style="max-width: 100%; height: auto;" />` : '<p style="text-align: center; font-size: 18px; font-weight: bold;">Cabinet d\'Ophtalmologie</p>'}
        </div>
        <div class="title">Prescription de lentilles de contact</div>
        <div class="patient-info">
          <p><strong>Patient(e) :</strong> ${patient.prenom} ${patient.nom}</p>
          ${patient.date_naissance ? `<p><strong>Date de naissance :</strong> ${format(new Date(patient.date_naissance), 'dd/MM/yyyy')}</p>` : ''}
          <p><strong>Date :</strong> ${format(new Date(prescription.date_prescription), 'dd/MM/yyyy')}</p>
        </div>
        <div class="prescription">
          <h3>Prescription</h3>
          <table class="prescription-table">
            <thead>
              <tr>
                <th>Œil</th>
                <th>Marque</th>
                <th>Sphère</th>
                ${hasCylindre ? '<th>Cylindre</th>' : ''}
                ${hasAxe ? '<th>Axe</th>' : ''}
                ${hasAddition ? '<th>Addition</th>' : ''}
                <th>Rayon (mm)</th>
                <th>Diamètre (mm)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>OD (Œil Droit)</strong></td>
                <td>${odLentille?.marque || '—'}</td>
                <td>${prescription.od_sphere || '—'}</td>
                ${hasCylindre ? `<td>${prescription.od_cylindre || '—'}</td>` : ''}
                ${hasAxe ? `<td>${prescription.od_axe ? prescription.od_axe + '°' : '—'}</td>` : ''}
                ${hasAddition ? `<td>${prescription.od_addition || '—'}</td>` : ''}
                <td>${prescription.od_rayon || '—'}</td>
                <td>${prescription.od_diametre || '—'}</td>
              </tr>
              <tr>
                <td><strong>OG (Œil Gauche)</strong></td>
                <td>${ogLentille?.marque || '—'}</td>
                <td>${prescription.og_sphere || '—'}</td>
                ${hasCylindre ? `<td>${prescription.og_cylindre || '—'}</td>` : ''}
                ${hasAxe ? `<td>${prescription.og_axe ? prescription.og_axe + '°' : '—'}</td>` : ''}
                ${hasAddition ? `<td>${prescription.og_addition || '—'}</td>` : ''}
                <td>${prescription.og_rayon || '—'}</td>
                <td>${prescription.og_diametre || '—'}</td>
              </tr>
            </tbody>
          </table>
          ${odLentille?.texte_impression || ogLentille?.texte_impression ? `
            <div class="lentille-info">
              <h4>Informations complémentaires</h4>
              ${odLentille?.texte_impression ? `<p><strong>OD:</strong> ${odLentille.texte_impression}</p>` : ''}
              ${ogLentille?.texte_impression ? `<p><strong>OG:</strong> ${ogLentille.texte_impression}</p>` : ''}
            </div>
          ` : ''}
          ${prescription.notes ? `
            <div class="lentille-info">
              <h4>Notes</h4>
              <p>${prescription.notes}</p>
            </div>
          ` : ''}
        </div>
        <div class="signature">
          <p>Le ${format(new Date(), 'dd/MM/yyyy')}</p>
          ${medecin?.signature_image_url ? `<img src="${medecin.signature_image_url}" alt="Signature" style="max-width: 200px; margin-top: 10px;" />` : '<p style="margin-top: 60px; border-top: 1px solid #000; display: inline-block; padding-top: 5px;">Signature</p>'}
        </div>
      </body>
      </html>
    `;
  };

  const handlePrint = (prescription) => {
    const htmlContent = genererHtmlPrescription(prescription);

    const printWindow = window.open('', '_blank');
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    printWindow.onload = () => {
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    };
  };

  const handleEnvoyerEmail = async (prescription) => {
    if (!patient.email) {
      toast.error("Le patient n'a pas d'adresse email renseignée");
      return;
    }

    const user = await base44.auth.me();
    const messagePersonnalise = user?.message_email_pdf || "Bonjour,\n\nVous trouverez ci-joint votre prescription de lentilles.\n\nCordialement,";
    
    const htmlContent = genererHtmlPrescription(prescription);
    const sujet = `Prescription de lentilles`;
    const nomFichier = `Prescription_Lentilles_${patient.nom}_${patient.prenom}_${format(new Date(), 'yyyyMMdd')}`;
    
    try {
      await genererPdfEtOuvrirEmail(htmlContent, patient.email, sujet, nomFichier, messagePersonnalise);
      toast.success("PDF généré et envoyé par email avec succès");
    } catch (error) {
      console.error('Erreur:', error);
      toast.error("Erreur lors de la génération ou l'envoi du PDF");
    }
  };

  const handleRenew = (prescription) => {
    const newPrescription = {
      patient_id: patientId,
      date_prescription: new Date().toISOString(),
      od_lentille_id: prescription.od_lentille_id,
      od_sphere: prescription.od_sphere,
      od_cylindre: prescription.od_cylindre,
      od_axe: prescription.od_axe,
      od_addition: prescription.od_addition,
      od_puissance: prescription.od_puissance,
      od_rayon: prescription.od_rayon,
      od_diametre: prescription.od_diametre,
      og_lentille_id: prescription.og_lentille_id,
      og_sphere: prescription.og_sphere,
      og_cylindre: prescription.og_cylindre,
      og_axe: prescription.og_axe,
      og_addition: prescription.og_addition,
      og_puissance: prescription.og_puissance,
      og_rayon: prescription.og_rayon,
      og_diametre: prescription.og_diametre,
      notes: prescription.notes
    };
    createPrescriptionMutation.mutate(newPrescription);
    setTimeout(() => {
      // Find the newly created prescription (or assume it's the latest one added)
      // For proper handling, this might require waiting for query invalidation and refetch,
      // then finding the item based on some unique property like patient_id and creation date.
      // For now, let's just use the current newPrescription object for printing.
      // In a real app, you might want to get the ID from the mutation success.
      handlePrint(newPrescription);
    }, 300); // Small delay to allow mutation to potentially register
  };

  return (
    <div className="space-y-6 pb-4">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-gray-900">Prescriptions de lentilles</h2>
        {canEdit && (
          <Button
            onClick={() => {
              resetForm();
              setShowDialog(true);
            }}
            className="bg-blue-600 hover:bg-blue-700 gap-2"
          >
            <Plus className="w-4 h-4" />
            Nouvelle prescription
          </Button>
        )}
      </div>

      {prescriptions.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center text-gray-500">
            <Eye className="w-16 h-16 mx-auto mb-4 text-gray-300" />
            <p>Aucune prescription de lentilles</p>
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-4">
          {prescriptions.map((prescription) => {
            const odLentille = lentilles.find(l => l.id === prescription.od_lentille_id);
            const ogLentille = lentilles.find(l => l.id === prescription.og_lentille_id);
            const datePrescription = new Date(prescription.date_prescription);
            const maintenant = new Date();
            const differenceHeures = (maintenant - datePrescription) / (1000 * 60 * 60);
            const peutSupprimer = canEdit && differenceHeures <= 24;

            return (
              <Card key={prescription.id} className="hover:shadow-lg transition-shadow">
                <CardHeader className="bg-gradient-to-r from-cyan-50 to-blue-50">
                  <div className="flex justify-between items-center">
                    <CardTitle className="text-lg">
                      Prescription du {format(new Date(prescription.date_prescription), 'dd/MM/yyyy')}
                    </CardTitle>
                    <div className="flex gap-2">
                      {canPrintOrEmail && (
                        <>
                          <Button variant="ghost" size="sm" onClick={() => handlePrint(prescription)}>
                            <Printer className="w-4 h-4" />
                          </Button>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => handleEnvoyerEmail(prescription)}
                            disabled={!patient.email}
                            title={patient.email ? "Envoyer par email" : "Email patient non renseigné"}
                          >
                            <Mail className="w-4 h-4" />
                          </Button>
                        </>
                      )}
                      {canEdit && (
                        <>
                          <Button variant="ghost" size="sm" onClick={() => handleRenew(prescription)} className="text-green-600">
                            <RefreshCw className="w-4 h-4" />
                          </Button>
                          <Button variant="ghost" size="sm" onClick={() => handleEdit(prescription)} className="text-blue-600">
                            <Edit className="w-4 h-4" />
                          </Button>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => handleDelete(prescription)} 
                            className="text-red-600"
                            disabled={!peutSupprimer}
                            title={peutSupprimer ? "Supprimer" : "Suppression impossible après 24h"}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </>
                      )}
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="pt-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <h3 className="font-semibold text-sm mb-3 text-gray-700">OD (Œil Droit)</h3>
                      <div className="space-y-2 text-sm">
                        {odLentille && <p><strong>Marque:</strong> {odLentille.marque}</p>}
                        {prescription.od_sphere && <p><strong>Sphère:</strong> {prescription.od_sphere}</p>}
                        {prescription.od_cylindre && <p><strong>Cylindre:</strong> {prescription.od_cylindre}</p>}
                        {prescription.od_axe && <p><strong>Axe:</strong> ${prescription.od_axe}°</p>}
                        {prescription.od_addition && <p><strong>Addition:</strong> {prescription.od_addition}</p>}
                        {prescription.od_rayon && <p><strong>Rayon:</strong> {prescription.od_rayon} mm</p>}
                        {prescription.od_diametre && <p><strong>Diamètre:</strong> {prescription.od_diametre} mm</p>}
                      </div>
                    </div>
                    <div>
                      <h3 className="font-semibold text-sm mb-3 text-gray-700">OG (Œil Gauche)</h3>
                      <div className="space-y-2 text-sm">
                        {ogLentille && <p><strong>Marque:</strong> {ogLentille.marque}</p>}
                        {prescription.og_sphere && <p><strong>Sphère:</strong> {prescription.og_sphere}</p>}
                        {prescription.og_cylindre && <p><strong>Cylindre:</strong> {prescription.og_cylindre}</p>}
                        {prescription.og_axe && <p><strong>Axe:</strong> ${prescription.og_axe}°</p>}
                        {prescription.og_addition && <p><strong>Addition:</strong> {prescription.og_addition}</p>}
                        {prescription.og_rayon && <p><strong>Rayon:</strong> {prescription.og_rayon} mm</p>}
                        {prescription.og_diametre && <p><strong>Diamètre:</strong> {prescription.og_diametre} mm</p>}
                      </div>
                    </div>
                  </div>
                  {prescription.notes && (
                    <div className="mt-4 pt-4 border-t">
                      <p className="text-sm"><strong>Notes:</strong> {prescription.notes}</p>
                    </div>
                  )}
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}

      <Dialog open={showDialog} onOpenChange={(open) => {
        setShowDialog(open);
        if (!open) resetForm();
      }}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Eye className="w-5 h-5" />
              {editingPrescription ? "Modifier" : "Nouvelle"} prescription de lentilles
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-6">
            <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4">
              <div className="space-y-3">
                <div>
                  <p className="text-sm font-semibold text-gray-700 mb-2">Copier depuis le dernier examen</p>
                  <p className="text-xs text-gray-600 mb-3">
                    Choisissez comment copier la réfraction subjective
                  </p>
                </div>
                <div className="flex gap-3 flex-wrap">
                  <Button
                    onClick={copierRefractionTelleQuelle}
                    variant="outline"
                    className="gap-2 bg-white hover:bg-green-50 border-green-300 flex-1"
                    disabled={!examensOrtho.length}
                  >
                    <Copy className="w-4 h-4" />
                    Copier tel quel
                  </Button>
                  <Button
                    onClick={convertirLunettesVersLentilles}
                    variant="outline"
                    className="gap-2 bg-white hover:bg-blue-50 border-blue-300 flex-1"
                    disabled={!examensOrtho.length}
                  >
                    <Glasses className="w-4 h-4" />
                    <ArrowRight className="w-4 h-4" />
                    <Eye className="w-4 h-4" />
                    Convertir lunettes → lentilles
                  </Button>
                </div>
                <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mt-2">
                  <p className="text-xs text-gray-700">
                    <strong>Copier tel quel :</strong> Cylindres -0.25 effacés • Cylindres -0.50 = équivalent sphérique • Table DVO 12mm + règle GADS
                    <br/>
                    <strong>Convertir :</strong> Cylindres -0.25 effacés • Cylindres -0.50 = équivalent sphérique • Table DVO 12mm + règle GADS
                  </p>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <Card className="border-2 border-orange-200">
                <CardHeader className="bg-orange-50 py-3">
                  <CardTitle className="text-base">OD (Œil Droit)</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3 pt-4">
                  <div>
                    <Label className="text-sm">Lentille</Label>
                    <Select
                      value={formData.od_lentille_id}
                      onValueChange={(value) => handleLentilleChange('od', value)}
                    >
                      <SelectTrigger className="text-sm">
                        <SelectValue placeholder="Sélectionner une lentille" />
                      </SelectTrigger>
                      <SelectContent>
                        {lentilles.map((lentille) => (
                          <SelectItem key={lentille.id} value={lentille.id}>
                            {lentille.marque} - {lentille.type_renouvellement}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-sm">Sphère</Label>
                      <Input
                        value={formData.od_sphere}
                        onChange={(e) => setFormData({ ...formData, od_sphere: e.target.value })}
                        placeholder="Ex: -3.75"
                        className="text-sm"
                      />
                    </div>
                    <div>
                      <Label className="text-sm">Cylindre</Label>
                      <Input
                        value={formData.od_cylindre}
                        onChange={(e) => setFormData({ ...formData, od_cylindre: e.target.value })}
                        placeholder="Ex: -1.25"
                        className="text-sm"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-sm">Axe</Label>
                      <Input
                        value={formData.od_axe}
                        onChange={(e) => setFormData({ ...formData, od_axe: e.target.value })}
                        placeholder="Ex: 180"
                        className="text-sm"
                      />
                    </div>
                    <div>
                      <Label className="text-sm">Addition</Label>
                      <Input
                        value={formData.od_addition}
                        onChange={(e) => setFormData({ ...formData, od_addition: e.target.value })}
                        placeholder="Ex: +2.00"
                        className="text-sm"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-sm">Rayon (mm)</Label>
                      <Input
                        value={formData.od_rayon}
                        onChange={(e) => setFormData({ ...formData, od_rayon: e.target.value })}
                        placeholder="Ex: 8.6"
                        className="text-sm"
                      />
                    </div>
                    <div>
                      <Label className="text-sm">Diamètre (mm)</Label>
                      <Input
                        value={formData.od_diametre}
                        onChange={(e) => setFormData({ ...formData, od_diametre: e.target.value })}
                        placeholder="Ex: 14.2"
                        className="text-sm"
                      />
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card className="border-2 border-green-200">
                <CardHeader className="bg-green-50 py-3">
                  <CardTitle className="text-base">OG (Œil Gauche)</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3 pt-4">
                  <div>
                    <Label className="text-sm">Lentille</Label>
                    <Select
                      value={formData.og_lentille_id}
                      onValueChange={(value) => handleLentilleChange('og', value)}
                    >
                      <SelectTrigger className="text-sm">
                        <SelectValue placeholder="Sélectionner une lentille" />
                      </SelectTrigger>
                      <SelectContent>
                        {lentilles.map((lentille) => (
                          <SelectItem key={lentille.id} value={lentille.id}>
                            {lentille.marque} - {lentille.type_renouvellement}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-sm">Sphère</Label>
                      <Input
                        value={formData.og_sphere}
                        onChange={(e) => setFormData({ ...formData, og_sphere: e.target.value })}
                        placeholder="Ex: -3.75"
                        className="text-sm"
                      />
                    </div>
                    <div>
                      <Label className="text-sm">Cylindre</Label>
                      <Input
                        value={formData.og_cylindre}
                        onChange={(e) => setFormData({ ...formData, og_cylindre: e.target.value })}
                        placeholder="Ex: -1.25"
                        className="text-sm"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-sm">Axe</Label>
                      <Input
                        value={formData.og_axe}
                        onChange={(e) => setFormData({ ...formData, og_axe: e.target.value })}
                        placeholder="Ex: 180"
                        className="text-sm"
                      />
                    </div>
                    <div>
                      <Label className="text-sm">Addition</Label>
                      <Input
                        value={formData.og_addition}
                        onChange={(e) => setFormData({ ...formData, og_addition: e.target.value })}
                        placeholder="Ex: +2.00"
                        className="text-sm"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-sm">Rayon (mm)</Label>
                      <Input
                        value={formData.og_rayon}
                        onChange={(e) => setFormData({ ...formData, og_rayon: e.target.value })}
                        placeholder="Ex: 8.6"
                        className="text-sm"
                      />
                    </div>
                    <div>
                      <Label className="text-sm">Diamètre (mm)</Label>
                      <Input
                        value={formData.og_diametre}
                        onChange={(e) => setFormData({ ...formData, og_diametre: e.target.value })}
                        placeholder="Ex: 14.2"
                        className="text-sm"
                      />
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            <div>
              <Label>Notes</Label>
              <Textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={3}
                placeholder="Notes additionnelles..."
              />
            </div>

            <div className="flex justify-end gap-3">
              <Button variant="outline" onClick={() => setShowDialog(false)}>
                Annuler
              </Button>
              <Button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700">
                {editingPrescription ? "Mettre à jour" : "Enregistrer"}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
